rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para obter perfil do usuário
    function getUserProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.perfil 
        : null;
    }
    
    function isAdmin() {
      return request.auth != null && getUserProfile() == 'admin';
    }
    
    function isPresidencia() {
      return request.auth != null && getUserProfile() == 'presidencia';
    }
    
    function isTesouraria() {
      return request.auth != null && getUserProfile() == 'tesouraria';
    }
    
    function isDiretoria() {
      return request.auth != null && getUserProfile() == 'diretoria';
    }
    
    function canManageUsers() {
      return isAdmin() || isPresidencia();
    }
    
    function canManageFinances() {
      return isAdmin() || isPresidencia() || isTesouraria();
    }
    
    function canViewReports() {
      return isAdmin() || isPresidencia() || isDiretoria() || isTesouraria();
    }
    
    // Regras para usuários
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (canManageUsers() || !exists(/databases/$(database)/documents/users/$(request.auth.uid)));
      allow update: if canManageUsers() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }
    
    // Regras para casas
    match /houses/{houseId} {
      allow read: if request.auth != null;
      allow write: if canManageUsers();
    }
    
    // Regras para posições das casas no mapa
    match /house_map_positions/{positionId} {
      allow read: if request.auth != null;
      allow write: if canManageUsers() || isDiretoria();
    }
    
    // Regras para moradores
    match /residents/{residentId} {
      allow read: if request.auth != null;
      allow write: if canManageUsers();
    }
    
    // Regras para valores fixos
    match /fixed_values/{valueId} {
      allow read: if request.auth != null;
      allow write: if canManageFinances();
    }
    
    // Regras para pagamentos fixos
    match /fixed_payments/{paymentId} {
      allow read: if request.auth != null;
      allow create, update: if canManageFinances();
      allow delete: if isAdmin();
    }
    
    // Regras para entradas
    match /entries/{entryId} {
      allow read: if canViewReports();
      allow create, update: if canManageFinances();
      allow delete: if isAdmin();
    }
    
    // Regras para despesas
    match /expenses/{expenseId} {
      allow read: if canViewReports();
      allow create, update: if canManageFinances();
      allow delete: if isAdmin();
    }
  }
}
